name: üöÄ Release

on:
  release:
    types: [created]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # üì¶ Build Cross-Platform Executables
  build-executables:
    name: üî® Build ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            arch: x64
            executable: pse-scraper
          - os: windows-latest
            platform: windows
            arch: x64
            executable: pse-scraper.exe
          - os: macos-latest
            platform: macos
            arch: x64
            executable: pse-scraper

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: üì¶ Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: üíæ Cache dependencies
        uses: actions/cache@v3
        with:
          path: .venv
          key: venv-${{ runner.os }}-3.10-${{ hashFiles('**/poetry.lock') }}

      - name: üìö Install dependencies
        run: poetry install --no-interaction

      - name: üî® Build executable
        run: |
          poetry run pyinstaller pse-scraper.spec

      - name: üìã Get release info
        id: release
        run: |
          echo "tag=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          echo "name=${{ github.event.release.name }}" >> $GITHUB_OUTPUT

      - name: üì¶ Package executable (Linux/macOS)
        if: matrix.platform != 'windows'
        run: |
          cd dist
          tar -czf pse-scraper-${{ steps.release.outputs.tag }}-${{ matrix.platform }}-${{ matrix.arch }}.tar.gz ${{ matrix.executable }}

      - name: üì¶ Package executable (Windows)
        if: matrix.platform == 'windows'
        run: |
          cd dist
          Compress-Archive -Path ${{ matrix.executable }} -DestinationPath pse-scraper-${{ steps.release.outputs.tag }}-${{ matrix.platform }}-${{ matrix.arch }}.zip

      - name: üì§ Upload executable to release (Linux/macOS)
        if: matrix.platform != 'windows'
        uses: softprops/action-gh-release@v1
        with:
          files: dist/pse-scraper-${{ steps.release.outputs.tag }}-${{ matrix.platform }}-${{ matrix.arch }}.tar.gz
          tag_name: ${{ github.event.release.tag_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üì§ Upload executable to release (Windows)
        if: matrix.platform == 'windows'
        uses: softprops/action-gh-release@v1
        with:
          files: dist/pse-scraper-${{ steps.release.outputs.tag }}-${{ matrix.platform }}-${{ matrix.arch }}.zip
          tag_name: ${{ github.event.release.tag_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ‚úÖ Release Success
  release-success:
    name: ‚úÖ Release Complete
    runs-on: ubuntu-latest
    needs: [build-executables]
    if: always()
    steps:
      - name: ‚úÖ Mark release as successful
        if: needs.build-executables.result == 'success'
        run: echo "üéâ Executable files successfully attached to release!"
        
      - name: ‚ùå Mark release as failed
        if: needs.build-executables.result == 'failure'
        run: |
          echo "‚ùå Executable build failed!"
          exit 1